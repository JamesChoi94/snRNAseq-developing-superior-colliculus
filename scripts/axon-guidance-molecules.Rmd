---
title: "Axon guidance molecule expression in developing SC"
author: "James Choi"
date: "Last compiled:`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, fig.align='center', 
                      tidy.opts=list(width.cutoff=80), tidy=TRUE,
                      results='hold')
knitr::opts_knit$set(root.dir = 'D:/MiamiProject/Park_snSeq_SuperiorColliculus/')
```

## Background

Superior colliculus is innervated by RGC axons during the early post-natal period i.e. between E19 and P8. Innervation by these projections have previously been described to be sequential - different anatomical areas of SC are innervated at different time (e.g. anterior vs posterior). 

Hypothesis: Cells of SC express axon guidance molecules in time-dependent manner that coincides with RGC projection innervation.

```{r directories}
results_out <- 'results/guidance-molecules/'
dir.create(path = results_out)
```


## Cells of developing superior colliculus

```{r libraries}
library(Seurat)
library(ggplot2)
library(dplyr)
library(KEGGREST)
library(ComplexHeatmap)
```

```{r load-data}
sc <- readRDS(file = 'data/AA_data/allages_dims20_res0.3_final_JSC.rds')
# There are excluded cells
# sc$celltype <- Idents(sc)
# sc <- sc[, sc$celltype != 'Excluded']
# tmp <- readRDS(file = 'data/SC_20200103.rds')
```


Analysis done by Ana.

```{r umaps, fig.height=4.5, fig.width=10}
sc$celltype <- factor(
  x = sc$celltype,
  levels = c('Excitatory Neuron', 'Inhibitory Neuron', 'Astrocyte', 'Oligo Lineage', 'Microglia', 'Fibroblast/Pericyte')
)
sc$Time <- factor(
  x = sc$Time,
  levels = c('E19','P4','P8','P21')
)
p1 <- DimPlot(sc, label = TRUE, group.by = 'celltype') +
  xlab(label = 'UMAP1') +
  ylab(label = 'UMAP2') +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = 'none')
p2 <- DimPlot(sc, group.by = 'Time', split.by = 'Time', ncol = 2) +
  xlab(label = 'UMAP1') +
  ylab(label = 'UMAP2') +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = 'none')
(p1 | p2) + patchwork::plot_layout()
```


## Guidance molecules - all cell-types

First we query expression of the axon guidance molecules in all cell-types.


### GeneCopoeia ExProfile Array

From https://www.genecopoeia.com/product/pathway-gene-qpcr-arrays/

Gene list #013 (QG013): ExProfileâ„¢ Human Extracellular Matrix and Adhesion Molecules Related Gene qPCR Array

```{r qg.genes}
# This was written manually because reading the PDF was a pain.
qg.genes <- c('SPG7','FN1','CD44','HPRT1','VTN','VCAM1','TNC','CLEC3B','TIMP3','TIMP2','TIMP1','THBS3','THBS2','THBS1','TGFBI','SPP1','SPG7','SPARC','SGCE','SELP','SELL','SELE','PECAM1','MMP9','MMP8','MMP7','MMP3','MMP16','MMP15','MMP14','MMP13','MMP12','MMP11','MMP10','MMP1','LAMB1','LAMA3','LAMA2','LAMA1','KAL1','ITGB5','ITGB3','ITGB3','ITGB2','ITGB1','ITGAV','ITGAM','ITGAL','ITGA8','ITGA7','ITGA6','ITGA5','ITGA4','ITGA2','ITGA1','ICAM1','CTNND1','CTNNB1','CTNNA1','CTGF','VCAN','COL8A1','COL6A2','COL6A1','COL5A1','COL4A2','COL1A1','COL16A1','COL15A1','COL14A1','COL12A1','COL11A1','CNTN1','ADAMTS8','ADAMTS1','COL7A1','COL12A1','CDH1','ECM1','HAS1','ITGA3','GAPDH','ACTB','B2M','RPL13A','HPRT1','RN18S1')
# Mouse ortholog name conversion
qg.genes <- plyr::mapvalues(
  x = qg.genes, 
  from = c('HPRT1', 'MMP1'),
  to = c('HPRT', 'MMP1B')
)
qg.genes <- unique(tools::toTitleCase(text = tolower(qg.genes)))
qg.genes.missing <- qg.genes[!qg.genes %in% rownames(sc)]
qg.genes <- qg.genes[qg.genes %in% rownames(sc)]
```

The following genes from adhesion molecule array were not found:


### KEGG pathway

```{r kegg-genes}
kegg.guidance.entry <- keggGet(dbentries = 'mmu04360')
kegg.guidance.genes <- kegg.guidance.entry[[1]]$GENE[seq(0,length(kegg.guidance.entry[[1]]$GENE),2)]
kegg.guidance.genes <- gsub("\\;.*","", kegg.guidance.genes)
kegg.guidance.genes.missing <- kegg.guidance.genes[!kegg.guidance.genes %in% rownames(sc)]
kegg.guidance.genes <- kegg.guidance.genes[kegg.guidance.genes %in% rownames(sc)]
```



## QG013 dot plot - all cell-types

```{r qg0130-dot-plot, fig.height=13, fig.width=8}
DefaultAssay(sc) <- 'RNA'
tmp <- DotPlot(sc, assay = 'RNA', features = qg.genes, split.by = 'Time', cols = rep('red',4))
plot.data <- tmp$data
plot.data$celltype <- sapply(strsplit(as.character(plot.data$id), '_'), `[`, 1)
plot.data$Time <- sapply(strsplit(as.character(plot.data$id), '_'), `[`, 2)
p1 <- plot.data %>% 
  group_by(features.plot) %>% 
  mutate(avg.exp = scale(avg.exp),
         Time = factor(Time, levels = levels(sc$Time)),
         celltype = factor(celltype, levels = levels(sc$celltype))) %>%
  ungroup() %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Time, 
                           y = features.plot,
                           size = pct.exp,
                           fill = avg.exp),
             pch = 21) + 
  facet_grid(. ~ celltype) +
  scale_fill_viridis_c(option = 'A') +
  theme_bw() +
  theme(axis.title.y = element_blank()) +
  guides(fill = guide_colorbar(frame.colour = 'black', 
                               ticks.colour = 'black'),
         size = guide_legend(override.aes = list(fill = 'black')))
ggsave(filename = paste(results_out, 'QG013-guidance-molecules_dotplot.tiff'), plot = p1, height = 13, width = 8, device = 'tiff')
p1
```

The QG013 dot plot some cell-type specificity of certain molecules:


* Tnc is expressed mostly by astrocytes and its expression decreases over time.
* Among the MMPs, MMP15 and MMP16 are highest expressed by Oligo lineage cells with decreases over time.
* Among the integrins, Itga6, Itga7, and Itgb5 show astrocyte specificity. Itga6 increases in astrocytes over time.
* Laminins show specificity: 
    + Lama1 is restricted to fibroblasts/pericytes.
    + Lama2 expressed by astrocytes and fibroblasts/pericytes with increasing trend over time. Interesting that mature Oligos express during/after myelination.
    + Lamb1 expression in fibroblasts/pericytes decreases over time.
* Many of the collagens are specific to fibroblasts/pericytes and show trend to decrease over time.
* Fibronectin and vitronectin show similar pattern to collagens but with more convincing decreases over time.


```{r tnc-umap, collapse=TRUE, fig.height=2.5, fig.width=10, fig.cap='Tnc expression'}
genes <- c('Tnc')
FetchData(sc, c('Time', genes, 'UMAP_1','UMAP_2')) %>% 
  reshape2::melt(id.vars = c('UMAP_1','UMAP_2','Time')) %>% 
  arrange(value) %>% 
  ggplot() +
  geom_point(aes(x = UMAP_1, y = UMAP_2, color = value), size = 0.75) +
  facet_grid(variable ~ Time) +
  scale_color_gradient(low = 'grey80', high = 'red3') +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  guides(color = guide_colorbar(frame.colour = 'black', ticks.colour = 'black'))
```

```{r mmp-umap, collapse=TRUE, fig.height=5, fig.width=10, fig.cap='MMP expression'}
genes <- c('Mmp15','Mmp16')
FetchData(sc, c('Time', genes, 'UMAP_1','UMAP_2')) %>% 
  reshape2::melt(id.vars = c('UMAP_1','UMAP_2','Time')) %>% 
  arrange(value) %>% 
  ggplot() +
  geom_point(aes(x = UMAP_1, y = UMAP_2, color = value), size = 0.75) +
  facet_grid(variable ~ Time) +
  scale_color_gradient(low = 'grey80', high = 'red3') +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  guides(color = guide_colorbar(frame.colour = 'black', ticks.colour = 'black'))
```

```{r integrin-umap, collapse=TRUE, fig.height=7.5, fig.width=10, fig.cap='Integrin expression'}
genes <- c('Itga6', 'Itga7', 'Itgb5')
FetchData(sc, c('Time', genes, 'UMAP_1','UMAP_2')) %>% 
  reshape2::melt(id.vars = c('UMAP_1','UMAP_2','Time')) %>% 
  arrange(value) %>% 
  ggplot() +
  geom_point(aes(x = UMAP_1, y = UMAP_2, color = value), size = 0.75) +
  facet_grid(variable ~ Time) +
  scale_color_gradient(low = 'grey80', high = 'red3') +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  guides(color = guide_colorbar(frame.colour = 'black', ticks.colour = 'black'))
```

```{r laminin-umap, collapse=TRUE, fig.height=7.5, fig.width=10, fig.cap='Laminin expression'}
genes <- c('Lama1','Lama2','Lamb1')
FetchData(sc, c('Time', genes, 'UMAP_1','UMAP_2')) %>% 
  reshape2::melt(id.vars = c('UMAP_1','UMAP_2','Time')) %>% 
  arrange(value) %>% 
  ggplot() +
  geom_point(aes(x = UMAP_1, y = UMAP_2, color = value), size = 0.75) +
  facet_grid(variable ~ Time) +
  scale_color_gradient(low = 'grey80', high = 'red3') +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  guides(color = guide_colorbar(frame.colour = 'black', ticks.colour = 'black'))
```

```{r ecm-umap, collapse=TRUE, fig.height=7.5, fig.width=10, fig.cap='Other EMC molecule expression'}
genes <- c('Col1a1','Vtn','Fn1')
FetchData(sc, c('Time', genes, 'UMAP_1','UMAP_2')) %>% 
  reshape2::melt(id.vars = c('UMAP_1','UMAP_2','Time')) %>% 
  arrange(value) %>% 
  ggplot() +
  geom_point(aes(x = UMAP_1, y = UMAP_2, color = value), size = 0.75) +
  facet_grid(variable ~ Time) +
  scale_color_gradient(low = 'grey80', high = 'red3') +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  guides(color = guide_colorbar(frame.colour = 'black', ticks.colour = 'black'))
```


## KEGG pathway - axon guidance dot plot

```{r kegg-dot-plot, fig.height=24, fig.width=8}
DefaultAssay(sc) <- 'RNA'
tmp <- DotPlot(sc, assay = 'RNA', features = sort(kegg.guidance.genes, decreasing = TRUE), split.by = 'Time', cols = rep('red',4))
plot.data <- tmp$data
plot.data$celltype <- sapply(strsplit(as.character(plot.data$id), '_'), `[`, 1)
plot.data$Time <- sapply(strsplit(as.character(plot.data$id), '_'), `[`, 2)
p2 <- plot.data %>% 
  group_by(features.plot) %>% 
  mutate(avg.exp = scale(avg.exp),
         Time = factor(Time, levels = levels(sc$Time)),
         celltype = factor(celltype, levels = levels(sc$celltype))) %>%
  ungroup() %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Time, 
                           y = features.plot,
                           size = pct.exp,
                           fill = avg.exp),
             pch = 21) + 
  facet_grid(. ~ celltype) +
  scale_fill_viridis_c(option = 'A') +
  # scale_fill_gradient2(low = 'blue', mid = 'white', high = 'red') +
  theme_bw() +
  theme(axis.title.y = element_blank()) +
  guides(fill = guide_colorbar(frame.colour = 'black', 
                               ticks.colour = 'black'),
         size = guide_legend(override.aes = list(fill = 'black')))
ggsave(filename = paste(results_out, 'KEGG-guidance-molecules_dotplot.tiff'), plot = p2, height = 25, width = 8, device = 'tiff')
p2
```


These dot plots aren't very informative or convincing of any conclusion at first glance.

## Guidance molecule expression at subtype-level

```{r}
old <- readRDS(file = 'data/AA_data/allages_dims20_res0.3_final_JSC.rds')
```

```{r all-cells-subtype-heatmap}
old$subtype <- paste(old$celltype, old$integrated_snn_res.0.3, sep = '.')
Idents(old) <- 'subtype'
plot.data <- DotPlot(old, features = kegg.guidance.genes, assay = 'RNA')
plot.data <- plot.data$data
tmp <- plot.data %>% 
  reshape2::acast(formula = id ~ features.plot, value.var = 'avg.exp.scaled')
subtype.hclust <- hclust(d = dist(x = tmp), method = 'ward.D2')
gene.hclust <- hclust(d = dist(x = t(tmp)), method = 'ward.D2')

tiff(filename = paste0(results_out, 'kegg-guidance-molecules_subtype-heatmap.tiff'), height = 5.5, width = 9, res = 440, units = 'in')
draw(ComplexHeatmap::Heatmap(
  matrix = tmp,
  cluster_rows = dendsort::dendsort(subtype.hclust),
  cluster_columns = dendsort::dendsort(gene.hclust),
  # show_row_names = FALSE,
  show_column_names = FALSE
))
dev.off()
```

```{r neurons-subtype-heatmap}
neurons <- old[, old$integrated_snn_res.0.3 %in% c(0,2,3,4,5,6,7,9,10,13,14,15,16,18,19,21,22,24,25)]
DimPlot(neurons, label = TRUE)
neurons$celltype.2 <- plyr::mapvalues(
  x = neurons$integrated_snn_res.0.3,
  from = c(0,2,3,4,5,6,7,9,10,13,14,15,16,18,19,21,22,24,25),
  to = c('ExNeuron', 'InNeuron','ExNeuron','ExNeuron','InNeuron','InNeuron','InNeuron','InNeuron','ExNeuron','ExNeuron','InNeuron','ExNeuron','ExNeuron','InNeuron','InNeuron','ExNeuron','ExNeuron','InNeuron','InNeuron')
)
neurons$subtype.2 <- paste0(neurons$celltype.2, neurons$integrated_snn_res.0.3)

Idents(neurons) <- 'subtype.2'
plot.data <- DotPlot(neurons, features = kegg.guidance.genes, assay = 'RNA')
plot.data <- plot.data$data
tmp <- plot.data %>% 
  reshape2::acast(formula = id ~ features.plot, value.var = 'avg.exp.scaled')
subtype.hclust <- hclust(d = dist(x = tmp), method = 'ward.D2')
gene.hclust <- hclust(d = dist(x = t(tmp)), method = 'ward.D2')

tiff(filename = paste0(results_out, 'kegg-guidance-molecules_neurons-subtype-heatmap.tiff'), height = 5.5, width = 9, res = 440, units = 'in')
draw(ComplexHeatmap::Heatmap(
  matrix = tmp,
  cluster_rows = dendsort::dendsort(subtype.hclust),
  cluster_columns = dendsort::dendsort(gene.hclust),
  # show_row_names = FALSE,
  show_column_names = FALSE
))
dev.off()
```


Tried ComplexHeatmap of neuronal cells using kegg genes, noisy and no clear patterns. Didn't include the "exclude" cells but still, think conclusion still stands.


```{r}
inh.neuron.paths <- list.files(
  path = 'data/',
  pattern = 'inh_neuron',
  full.names = TRUE
)
inh.neurons <- lapply(
  X = inh.neuron.paths,
  FUN = readRDS
)
names(inh.neurons) <- c('E19','P21', 'P4', 'P8')
inh.metadata <- lapply(
  X = inh.neurons,
  FUN = function(x) x@meta.data
)
inh.metadata <- Reduce(f = rbind, x = inh.metadata)

p.cluster <- lapply(
  X = inh.neurons,
  FUN = DimPlot,
  label = TRUE
)
p.time <- lapply(
  X = inh.neurons,
  FUN = DimPlot,
  group.by = 'Time'
)
cowplot::plot_grid(plotlist = p.cluster, ncol = 4) /
  cowplot::plot_grid(plotlist = p.time, ncol = 4)
```


```{r}
DefaultAssay(sc) <- 'RNA'
ex.neuron <- sc[, sc$celltype == 'Excitatory Neuron']
in.neuron <- sc[, sc$celltype == 'Inhibitory Neuron']
neuron <- sc[, sc$celltype %in% c('Excitatory Neuron', 'Inhibitory Neuron')]
guidance.genes <- union(qg.genes, kegg.guidance.genes)
neuron <- neuron %>% 
  NormalizeData() %>% 
  ScaleData(features = guidance.genes) %>% 
  RunPCA(features = guidance.genes)
p1 <- DimPlot(neuron, reduction = 'pca', group.by = 'celltype', shuffle = TRUE)
p2 <- DimPlot(neuron, reduction = 'pca', group.by = 'Time', shuffle = TRUE)
p1 | p2

```



```{r time-course, eval=FALSE}
DefaultAssay(sc) <- 'RNA'
tmp <- ScaleData(object = sc, features = union(kegg.guidance.genes, qg.genes))
tmp <- FetchData(
  object = sc, 
  vars = c(union(kegg.guidance.genes, qg.genes), 'Time', 'celltype'), 
  slot = 'data'
) %>% 
  mutate(across(where(is.numeric), scale)) %>%
  group_by(celltype, Time) %>% 
  summarise(across(.cols = everything(), .fns = mean)) %>%
  ungroup() %>% 
  reshape2::melt(id.vars = c('celltype','Time')) %>% 
  mutate(obs_id = paste(celltype, variable, sep = '_')) %>% 
  select(c('obs_id', 'Time', 'value')) %>% 
  reshape2::acast(formula = obs_id ~ Time)
tmp.dist <- dist(x = tmp)
tmp.hclust <- hclust(d = tmp.dist, method = 'ward.D2')
tmp.cluster <- cutree(tree = tmp.hclust, h = 10)
cbind(as.data.frame(tmp), 'cluster' = tmp.cluster) %>% 
  tibble::rownames_to_column('obs') %>% 
  reshape2::melt(id.vars = c('obs', 'cluster')) %>% 
  ggplot(mapping = aes(x = variable, y = value, group = obs, color = cluster)) +
  geom_line() +
  theme(legend.position = 'none')
```


## END

```{r}
sessionInfo()
```

